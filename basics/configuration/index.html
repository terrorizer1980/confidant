<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Confidant: Configuration</title>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Source+Code+Pro">
    <link href="../../stylesheets/site-80875ad0.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
      <header id="header">
    <nav class="global-nav" role="navigation">
  <section class="wrap-container">
    <header class="global-nav-item logo-text">
      <a class="global-nav-logo" href="../../">Confidant</a>
    </header>

    <ul class="global-nav-list">
      <li class="global-nav-item">
        <a href="//twitter.com/share" class="twitter-share-button" data-text="Confidant, your secret keeper" data-via="lyft" data-count="none">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

      </li>
      <li class="global-nav-item">
        <iframe src="//ghbtns.com/github-btn.html?user=lyft&repo=confidant&type=watch" height="30" width="70" frameborder="0" scrolling="0" style="width:70px; height: 30px;" class="github-btn" allowTransparency="true"></iframe>

      </li>
      <li class="global-nav-item">
        <a class="cta-link-nav-filled" href="../install/">Docs</a>
      </li>
    </ul>
  </section>
</nav>

  </header>

  <div class="body-content-container wrap-container" role="main">
    <nav id="toc" class="sidebar" data-waypoint="sidebar">
      <div id="search" role="search">
  <form>
    <input autocomplete="on" class="ui-autocomplete-input" id="searchbox" placeholder="Search the docs" type="search">
  </form>
</div>

<div class="toc-block-container">
  <div class="toc-block">
    <h3 class="docs-section-heading">Basics</h3>
    <ul>
      <li class="doc-item">
        <a href="../install/">Install</a> </li>
      <li class="doc-item">
        <a href="./">Configure</a>
        </li>
      <li class="doc-item">
        <a href="../using_confidant/">Managing secrets and mappings</a>
        </li>
    </ul>
  </div>

  <div class="toc-block">
    <h3 class="docs-section-heading">Advanced</h3>
    <ul>
      <li class="doc-item">
        <a href="../../advanced/threat_model/">Threat Model</a>
        </li>
      <li class="doc-item">
        <a href="../../advanced/service_to_service_auth/">Service-to-service authentication and encryption</a>
        </li>
      <li class="doc-item">
        <a href="../../advanced/contributing/">Contributing</a>
        </li>
      <li class="doc-item">
        <a href="../../advanced/data_schema/">Data Schema</a>
        </li>
    </ul>
  </div>
  <div class="toc-block">
    <h3 class="docs-section-heading">Communication</h3>
    <ul>
      <li class="doc-item">
        <a href="../../communication/support/">Support</a>
	</li>
      <li class="doc-item">
        <a href="../../communication/security_reporting/">Security Reporting</a>
	</li>
    </ul>
  </div>
</div>

    </nav>

    <main class="main" role="main" data-waypoint="main">
      <h1 id="configuration">Configuration</h1>

<p>Confidant is primarily configured through environment variables. The list of
all available configuration options can be found in the settings.py file.</p>

<p>Prerequisites not covered by this guide:</p>

<ol>
<li>Your Google application is setup and you know your client id and secret key.</li>
</ol>

<h2 id="docker-vs-bash">Docker vs bash</h2>

<p>Note that below the format of the configuration is given in bash format for
defining and exporting environment variables. Docker environment files have a
slightly different format than bash. Here&#39;s an example of the difference:</p>

<p>In bash format:</p>

<pre><code class="bash">export MY_VARIABLE=&#39;MY_VALUE&#39;
</code></pre>

<p>In docker env file format, you don&#39;t export the variable, and the value
shouldn&#39;t be quoted, since everything after the equal sign is considered part
of the value. So, in a docker environment file, you&#39;d define the same variable
and value like this:</p>

<p>In docker format:</p>

<pre><code>MY_VARIABLE=MY_VALUE
</code></pre>

<h2 id="basic-environment-configuration">Basic environment configuration</h2>

<p>This is the minimum configuration needed to use Confidant:</p>

<pre><code class="bash"># The region our service is running in.
export AWS_DEFAULT_REGION=&#39;us-east-1&#39;
# The IAM role name of the confidant server.
export AUTH_CONTEXT=&#39;confidant-production&#39;
# The KMS key used for auth.
export AUTH_KEY=&#39;authnz-production&#39;
# A long randomly generated string used for the google OAuth2 flow.
export AUTHOMATIC_SALT=&#39;H39bfLCqLbrYrFyiJIxkK0uf12rlzvgjgo9FqOnttPXIdAAuyQ&#39;
# The DynamoDB table name for storage.
export DYNAMODB_TABLE=&#39;confidant-production&#39;
# Set the gevent resolver to ares; see:
#   https://github.com/surfly/gevent/issues/468
export GEVENT_RESOLVER=&#39;ares&#39;
# The client id and consumer secret from the google developer console.
export GOOGLE_OAUTH_CLIENT_ID=&#39;123456789-abcdefghijklmnop.apps.googleusercontent.com&#39;
export GOOGLE_OAUTH_CONSUMER_SECRET=&#39;123456789abcdefghijklmnop&#39;
# The KMS key used for at-rest encryption in DynamoDB.
export KMS_MASTER_KEY=&#39;confidant-production&#39;
# The Redis server used for sessions.
export REDIS_URL=&#39;redis://localhost:6381&#39;
# A long randomly generated string for CSRF protection.
export SESSION_SECRET=&#39;aBVmJA3zv6zWGjrYto135hkdox6mW2kOu7UaXIHK8ztJvT8w5O&#39;
# The IP address to listen on.
export HOST=&#39;0.0.0.0&#39;
# The port to listen on.
export PORT=&#39;80&#39;
</code></pre>

<h2 id="advanced-environment-configuration">Advanced environment configuration</h2>

<p>Confidant can track some stats via statsd. By default it&#39;s set to send stats to
statsd on localhost on port 8125.</p>

<pre><code class="bash">export STATSD_HOST=&#39;mystatshost.example.com&#39;
export STATSD_PORT=&#39;8125&#39;
</code></pre>

<p>Confidant can also send graphite events on secret updates or changes in service
mappings:</p>

<pre><code class="bash">export GRAPHITE_EVENT_URL=&#39;https://graphite.example.com/events/&#39;
export GRAPHITE_USERNAME=&#39;mygraphiteuser&#39;
export GRAPHITE_PASSWORD=&#39;mylongandsupersecuregraphitepassword&#39;
</code></pre>

<p>It&#39;s possible to restrict access to a subset of users that authenticate
using Google authentication:</p>

<pre><code class="bash">export USERS_FILE=&#39;/etc/confidant/users.yaml&#39;
export GOOGLE_AUTH_EMAIL_SUFFIX=&#39;@example.com&#39;
</code></pre>

<p>In the above configuration, Confidant will limit authentication to users with
the email domain @example.com. Additionally, Confidant will look in the
users.yaml file for a list of email addresses allowed to access Confidant.</p>

<p>It&#39;s possible to limit the lifetime of KMS authentication tokens. By default
Confidant limits token lifetime to 60 minutes, to ensure that tokens are being
rotated. To change this, you can use the following option:</p>

<pre><code class="bash"># Limit token lifetime to 10 minutes.
export AUTH_TOKEN_MAX_LIFETIME=&#39;10&#39;
</code></pre>

<p>It&#39;s possible to customize portions of the angularjs application.
Currently you can add a documentation section to the credential details view.
We&#39;d like to make more customization available. Please open a github issue with
specific customizations you&#39;d like focused on first. The custom js/css/html
will be served from a directory you specify:</p>

<pre><code class="bash">export CUSTOM_FRONTEND_DIRECTORY=&#39;/srv/confidant-static&#39;
</code></pre>

<p>There&#39;s a few settings that are meant for development or testing purposes only
and should never be used in production:</p>

<pre><code class="bash"># Disable all forms of authentication.
# NEVER USE THIS IN PRODUCTION!
export USE_AUTH=false
# Disable any use of at-rest encryption.
# NEVER USE THIS IN PRODUCTION!
export USE_ENCRYPTION=false
# Disable SSLify
# NEVER USE THIS IN PRODUCTION!
export SSLIFY=false
# Enable debug mode, which will also disable SSLify.
# NEVER USE THIS IN PRODUCTION!
export DEBUG=true
</code></pre>

<h2 id="kms-key-policy-configuration">KMS key policy configuration</h2>

<p>Confidant needs to have special KMS key policy for both the at-rest
KMS_MASTER_KEY and the authentication AUTH_KEY.</p>

<p>Here&#39;s an example key policy for the at-rest encryption key, KMS_MASTER_KEY, assuming the
above configuration. Note the following:</p>

<ol>
<li>The &quot;Enable IAM User Permissions&quot; policy ensures that IAM users in your account
that have the proper IAM permissions can manage this key. This is here to
ensure you don&#39;t lock yourself out of the key.</li>
<li>The &quot;Allow access for Key Administrators&quot; policy ensures that a special IAM
user can manage the KMS key.</li>
<li>The &quot;Allow use of the key&quot; policy ensures that confidant can use the key.</li>
</ol>

<pre><code class="json">{
  &quot;Version&quot; : &quot;2012-10-17&quot;,
  &quot;Id&quot; : &quot;key-consolepolicy-1&quot;,
  &quot;Statement&quot; : [ {
    &quot;Sid&quot; : &quot;Enable IAM User Permissions&quot;,
    &quot;Effect&quot; : &quot;Allow&quot;,
    &quot;Principal&quot; : {
      &quot;AWS&quot; : &quot;arn:aws:iam::12345:root&quot;
    },
    &quot;Action&quot; : &quot;kms:*&quot;,
    &quot;Resource&quot; : &quot;*&quot;
  }, {
    &quot;Sid&quot; : &quot;Allow access for Key Administrators&quot;,
    &quot;Effect&quot; : &quot;Allow&quot;,
    &quot;Principal&quot; : {
      &quot;AWS&quot; : &quot;arn:aws:iam::12345:user/myadminuser&quot;
    },
    &quot;Action&quot; : [ &quot;kms:Describe*&quot;, &quot;kms:List*&quot;, &quot;kms:Create*&quot;, &quot;kms:Revoke*&quot;,
&quot;kms:Enable*&quot;, &quot;kms:Get*&quot;, &quot;kms:Disable*&quot;, &quot;kms:Delete*&quot;, &quot;kms:Put*&quot;,
&quot;kms:Update*&quot; ],
    &quot;Resource&quot; : &quot;*&quot;
  }, {
    &quot;Sid&quot; : &quot;Allow use of the key&quot;,
    &quot;Effect&quot; : &quot;Allow&quot;,
    &quot;Principal&quot; : {
      &quot;AWS&quot; : &quot;arn:aws:iam::12345:role/confidant-production&quot;
    },
    &quot;Action&quot; : [ &quot;kms:Decrypt&quot;, &quot;kms:GenerateDataKey*&quot;, &quot;kms:ReEncrypt*&quot;,
&quot;kms:DescribeKey&quot;, &quot;kms:Encrypt&quot; ],
    &quot;Resource&quot; : &quot;*&quot;
  } ]
}
</code></pre>

<p>Here&#39;s an example key policy for the authentication key, AUTH_KEY, assuming the
above configuration. Note the following:</p>

<ol>
<li>The &quot;Enable IAM User Permissions&quot; policy ensures that IAM users in your account
that have the proper IAM permissions can manage this key. This is here to
ensure you don&#39;t lock yourself out of the key.</li>
<li>The &quot;Allow access for Key Administrators&quot; policy ensures that a special IAM
user can manage the KMS key.</li>
<li>The &quot;Allow use of the key&quot; policy ensures that confidant can use the key.</li>
<li>The &quot;Allow attachment of persistent resources&quot; policy ensures that confidant
can add and revoke grants for the auth key, which is necessary to give
access to context specific encrypt and decrypt calls for service IAM roles.</li>
</ol>

<pre><code class="json">{
  &quot;Version&quot; : &quot;2012-10-17&quot;,
  &quot;Id&quot; : &quot;key-consolepolicy-1&quot;,
  &quot;Statement&quot; : [ {
    &quot;Sid&quot; : &quot;Enable IAM User Permissions&quot;,
    &quot;Effect&quot; : &quot;Allow&quot;,
    &quot;Principal&quot; : {
      &quot;AWS&quot; : &quot;arn:aws:iam::12345:root&quot;
    },
    &quot;Action&quot; : &quot;kms:*&quot;,
    &quot;Resource&quot; : &quot;*&quot;
  }, {
    &quot;Sid&quot; : &quot;Allow access for Key Administrators&quot;,
    &quot;Effect&quot; : &quot;Allow&quot;,
    &quot;Principal&quot; : {
      &quot;AWS&quot; : &quot;arn:aws:iam::12345:user/myadminuser&quot;
    },
    &quot;Action&quot; : [ &quot;kms:Describe*&quot;, &quot;kms:List*&quot;, &quot;kms:Create*&quot;, &quot;kms:Revoke*&quot;,
&quot;kms:Enable*&quot;, &quot;kms:Get*&quot;, &quot;kms:Disable*&quot;, &quot;kms:Delete*&quot;, &quot;kms:Put*&quot;,
&quot;kms:Update*&quot; ],
    &quot;Resource&quot; : &quot;*&quot;
  }, {
    &quot;Sid&quot; : &quot;Allow use of the key&quot;,
    &quot;Effect&quot; : &quot;Allow&quot;,
    &quot;Principal&quot; : {
      &quot;AWS&quot; : &quot;arn:aws:iam::12345:role/confidant-production&quot;
    },
    &quot;Action&quot; : [ &quot;kms:Decrypt&quot;, &quot;kms:GenerateDataKey*&quot;, &quot;kms:ReEncrypt*&quot;,
&quot;kms:DescribeKey&quot;, &quot;kms:Encrypt&quot; ],
    &quot;Resource&quot; : &quot;*&quot;
  }, {
    &quot;Sid&quot; : &quot;Allow attachment of persistent resources&quot;,
    &quot;Effect&quot; : &quot;Allow&quot;,
    &quot;Principal&quot; : {
      &quot;AWS&quot; : &quot;arn:aws:iam::12345:role/confidant-production&quot;
    },
    &quot;Action&quot; : [ &quot;kms:ListGrants&quot;, &quot;kms:CreateGrant&quot;, &quot;kms:RevokeGrant&quot; ],
    &quot;Resource&quot; : &quot;*&quot;
  } ]
}
</code></pre>

<h2 id="confidant-iam-role-configuration">Confidant IAM role configuration</h2>

<p>Confidant needs some IAM policies to properly function. Here&#39;s some example
policies, based on the above configuration:</p>

<p>A policy to find instance profiles, so that Confidant can know which IAM roles
exist. This is to make it easier for users to find which services they can
create.</p>

<pre><code class="json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Action&quot;: [
                &quot;iam:ListRoles&quot;,
                &quot;iam:GetRole&quot;
            ],
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Resource&quot;: &quot;*&quot;
        }
    ]
}
</code></pre>

<p>Allow Confidant to generate random data from KMS:</p>

<pre><code class="json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Action&quot;: [
                &quot;kms:GenerateRandom&quot;
            ],
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Resource&quot;: &quot;*&quot;
        }
    ]
}
</code></pre>

<p>Allow Confidant access to its DynamoDB table. We restrict DeleteTable access,
because the application should never be able to do that.</p>

<pre><code class="json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Action&quot;: [
                &quot;dynamodb:*&quot;
            ],
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Resource&quot;: [
                &quot;arn:aws:dynamodb:*:*:table/confidant-production&quot;,
                &quot;arn:aws:dynamodb:*:*:table/confidant-production/*&quot;
            ]
        },
        {
            &quot;Action&quot;: [
                &quot;dynamodb:DeleteTable&quot;
            ],
            &quot;Effect&quot;: &quot;Deny&quot;,
            &quot;Resource&quot;: [
                &quot;arn:aws:dynamodb:*:*:table/confidant-production&quot;
            ]
        }
    ]
}
</code></pre>

<h2 id="confidant-dynamodb-table-configuration">Confidant DynamoDB table configuration</h2>

<p>You&#39;ll need to create a dynamodb with two global indexes:</p>

<pre><code>hash id: id
hash key data type: S

global indexes:

data_type_date_index:
  hash key: data_type
  hash key data type: S
  range key: modified_date
  range key data type: S

data_type_revision_index:
  hash key: data_type
  hash key data type: S
  range key: revision
  range key data type: N
</code></pre>

<p>Provisioned read/write units can be relative low on both the primary table and
the indexes. See your usage in cloudwatch and increase throughput as necessary.</p>

    </main>
  </div>

    <footer class="footer" data-waypoint="footer" role="contentinfo">
  <div class="wrap-container">
    <div class="footer-column">
      <article class="footer-site-information">
        <p>
          &copy; 2014&ndash;2016 Lyft, Inc
        </p>
      </article>
      <article class="footer-contact">
        <ul class="footer-contact-list">
          <li class="footer-contact-list-item twitter-link">
            <a href="//twitter.com/share" class="twitter-share-button" data-text="Confidant, your secret keeper" data-via="lyft" data-count="none">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

          </li>
          <li class="footer-contact-list-item github-link">
            <iframe src="//ghbtns.com/github-btn.html?user=lyft&repo=confidant&type=watch" height="30" width="70" frameborder="0" scrolling="0" style="width:70px; height: 30px;" class="github-btn" allowTransparency="true"></iframe>

          </li>
          <li class="footer-contact-list-item">
            <a href="//www.lyft.com/app">Download the Lyft app</a>
          </li>
        </ul>
      </article>
    </div>
    <div class="footer-column footer-right">
      <p class="footer-credit">
        From the developers at
      </p>
      <a href="//lyft.com" target="_blank">
        <span class="footer-logo"></span>
      </a>
    </div>
  </div>
</footer>

    <script src="../../javascripts/site-0138815e.js" type="text/javascript"></script>
    <script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-1446928-11']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>

  </body>
</html>
